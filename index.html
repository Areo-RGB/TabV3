<!doctype html> <!-- MUST be the very first line -->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Übersicht - Spielergebnisse</title>

    <!-- Tabler CSS -->
    <link href="./dist/css/tabler.min.css" rel="stylesheet" />
    <link href="./dist/css/tabler-flags.min.css" rel="stylesheet" />
    <link href="./dist/css/tabler-socials.min.css" rel="stylesheet" />
    <link href="./dist/css/tabler-payments.min.css" rel="stylesheet" />
    <link href="./dist/css/tabler-vendors.min.css" rel="stylesheet" />
    <link href="./preview/css/demo.min.css" rel="stylesheet" />

    <!-- === Libraries FIRST === -->
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Chart.js Datalabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>    <style>
      /* Optional: Add some margin between charts */
      .chart-card {
        margin-bottom: 1.5rem;
      }
      /* Ensure canvas is responsive within its container width-wise */
      canvas {
          max-width: 100%;
      }
      /* Style for the custom legend item */
      .legend-item-failed {
          color: #999; /* Grey text */
          text-decoration: line-through; /* Optional: strike-through */
      }
      /* Add drop shadow to cards */
      .card {
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          transition: box-shadow 0.3s ease;
      }
      .card:hover {
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="navbar navbar-expand-md d-print-none">
        <div class="container-xl">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </header>
      <header class="navbar-expand-md">
         <!-- Navbar content -->
         <div class="collapse navbar-collapse" id="navbar-menu">
          <div class="navbar">
            <div class="container-xl">
              <div class="row flex-fill align-items-center">
                <div class="col">
                   <ul class="navbar-nav">
                    <li class="nav-item active"> <!-- Übersicht is active -->
                      <a class="nav-link" href="./index.html">
                        <span class="nav-link-icon d-md-none d-lg-inline-block">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l-2 0l9 -9l9 9l-2 0" /><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" /><path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" /></svg>
                        </span>
                        <span class="nav-link-title"> Übersicht </span>
                      </a>
                    </li>
                    <li class="nav-item"> <!-- Finley -->
                      <a class="nav-link" href="./finley.html">
                        <span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1"><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /></svg></span>
                        <span class="nav-link-title"> Finley </span>
                      </a>
                    </li>
                    <li class="nav-item"> <!-- Bent -->
                      <a class="nav-link" href="./bent.html">
                         <span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1"><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /></svg></span>
                        <span class="nav-link-title"> Bent </span>
                      </a>
                    </li>
                    <li class="nav-item"> <!-- Alex -->
                      <a class="nav-link" href="./alex.html">
                         <span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-1"><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0" /><path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /></svg></span>
                        <span class="nav-link-title"> Alex </span>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
      <div class="page-wrapper">
        <div class="page-header d-print-none">
          <div class="container-xl">
            <h2 class="page-title">Übersicht Spielergebnisse</h2>
          </div>
        </div>
        <div class="page-body">
          <div class="container-xl">
            <div class="row row-cards">

              <!-- Chart Canvas Elements -->
              <div class="col-lg-6 chart-card">
                <div class="card"><div class="card-body"><h3 class="card-title">Sprintzeiten</h3><canvas id="sprintChart"></canvas></div></div>
              </div>
              <div class="col-lg-6 chart-card">
                 <div class="card"><div class="card-body"><h3 class="card-title">Gewandtheit</h3><canvas id="agilityChart"></canvas></div></div>
               </div>
              <div class="col-lg-6 chart-card">
                <div class="card"><div class="card-body"><h3 class="card-title">Balltechnik</h3><canvas id="ballSkillsTimeChart"></canvas></div></div>
              </div>
               <div class="col-lg-6 chart-card">
                <div class="card"><div class="card-body"><h3 class="card-title">Balljonglieren</h3><canvas id="jugglingChart"></canvas></div></div>
              </div>
              <div class="col-lg-6 chart-card">
                <div class="card"><div class="card-body"><h3 class="card-title">YoYo IR1 Test</h3><canvas id="yoyoChart"></canvas></div></div>
              </div>

            </div> <!-- End row -->
          </div> <!-- End container -->
        </div> <!-- End page-body -->
      </div> <!-- End page-wrapper -->
    </div> <!-- End page -->

    <!-- Tabler JS (deferred) -->
    <script src="./dist/js/tabler.min.js" defer></script>

    <!-- === Custom Chart Logic LAST, inside DOMContentLoaded === -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Ensure Chart and ChartDataLabels are available
        if (typeof Chart === 'undefined') { console.error("FATAL: Chart.js library not loaded!"); return; }
        if (typeof ChartDataLabels === 'undefined') { console.warn("WARN: ChartDataLabels plugin not loaded. Labels will not appear."); /* Continue without labels */ }
        else { Chart.register(ChartDataLabels); } // Register only if loaded

        // --- Data and Helper Functions ---
         const rawData = [
           { uebung: "10m Sprint", name: "Finley", ergebnis: 2.00 }, { uebung: "20m Sprint", name: "Finley", ergebnis: 3.59 }, { uebung: "Gewandtheit", name: "Finley", ergebnis: 7.81 }, { uebung: "Dribbling", name: "Finley", ergebnis: 10.27 }, { uebung: "Balljonglieren", name: "Finley", ergebnis: 0.00 }, { uebung: "Ballkontrolle", name: "Finley", ergebnis: 10.82 }, { uebung: "YoYo IR1", name: "Finley", ergebnis: 640 },
           { uebung: "10m Sprint", name: "Alex", ergebnis: 2.16 }, { uebung: "20m Sprint", name: "Alex", ergebnis: 3.78 }, { uebung: "Gewandtheit", name: "Alex", ergebnis: 7.39 }, { uebung: "Dribbling", name: "Alex", ergebnis: 10.00 }, { uebung: "Ballkontrolle", name: "Alex", ergebnis: 8.92 }, { uebung: "YoYo IR1", name: "Alex", ergebnis: 1720 },
           { uebung: "10m Sprint", name: "Bent", ergebnis: 2.32 }, { uebung: "20m Sprint", name: "Bent", ergebnis: 3.82 }, { uebung: "Gewandtheit", name: "Bent", ergebnis: 9.17 }, { uebung: "Balljonglieren", name: "Bent", ergebnis: 3 },
         ];
        const players = ["Finley", "Alex", "Bent"]; // Define all possible players

        function getChartData(exercises, players) {
            const datasets = players.map((player, index) => {
            const data = exercises.map(exercise => {
                const record = rawData.find(item => item.name === player && item.uebung === exercise);
                const value = record?.ergebnis;
                if (value !== undefined && value !== null && value !== '') { const num = parseFloat(value); return isNaN(num) ? null : num; } return null;
            });
            // Assign color based on the original index in the full 'players' list
            const playerIndex = players.indexOf(player);
            const colors = [ 'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)' ];
            const borderColors = [ 'rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)' ];
            return { label: player, data: data, backgroundColor: colors[playerIndex % colors.length], borderColor: borderColors[playerIndex % borderColors.length], borderWidth: 1 };
            });
            return { labels: exercises, datasets: datasets };
        }

        function calculateTimeAxisRange(datasets) {
             if (!Array.isArray(datasets) || datasets.length === 0) { return { min: 0, max: 10 }; }
            let minVal = Infinity, maxVal = -Infinity, hasValidData = false;
            datasets.forEach(dataset => { if (dataset && Array.isArray(dataset.data)) { dataset.data.forEach(value => { if (value !== null && typeof value === 'number' && !isNaN(value)) { if (value < minVal) minVal = value; if (value > maxVal) maxVal = value; hasValidData = true; } }); } });
            if (!hasValidData) { return { min: 0, max: 10 }; } const range = maxVal - minVal; const padding = Math.max(range * 0.1, 0.1); const suggestedMin = Math.max(0, Math.floor((minVal - padding * 1.5) * 10) / 10); const suggestedMax = Math.ceil((maxVal + padding) * 10) / 10;
            if (suggestedMax <= suggestedMin + 0.1) { return { min: Math.max(0, suggestedMin - 0.2), max: suggestedMax + 0.2 }; } return { min: suggestedMin, max: suggestedMax };
        }

        const defaultDatalabelsConfig = {
             anchor: 'end', align: 'top', formatter: (value, context) => { if (value === null) return null; let chartId = context.chart?.canvas?.id; if (chartId === 'jugglingChart') return value; if (chartId === 'yoyoChart') return value + 'm'; if (typeof value === 'number') { return value.toFixed(2) + 's'; } return value; }, font: { weight: 'bold', size: 10 }, color: '#444'
        };

       function filterEmptyDatasets(chartData) {
            if (!chartData || !Array.isArray(chartData.datasets)) { console.error("filterEmptyDatasets received invalid chartData:", chartData); return { labels: chartData?.labels || [], datasets: [] }; }
            const filteredDatasets = chartData.datasets.filter(dataset => dataset && Array.isArray(dataset.data) && dataset.data.some(value => value !== null && typeof value === 'number' && !isNaN(value)) );
            return { labels: chartData.labels, datasets: filteredDatasets };
       }

        // --- Chart Creation Logic ---
        function createChart(canvasId, exercises, type = 'bar', optionsOverrides = {}, axisType = 'time') {
            const canvas = document.getElementById(canvasId);
            if (!canvas) { console.error(`Canvas element with ID "${canvasId}" not found.`); return null; }
            const ctx = canvas.getContext('2d');
            if (!ctx) { console.error(`Could not get 2D context for canvas "${canvasId}".`); return null; }

            // Get data for ALL players first
            let fullChartData = getChartData(exercises, players);
            // Filter out players with no valid data for this chart's exercises
            let filteredChartData = filterEmptyDatasets(fullChartData);

            // --- Special Handling for Balltechnik Chart Legend ---
            let addBentLegendNote = false;
            if (canvasId === 'ballSkillsTimeChart' && players.includes('Bent') && !filteredChartData.datasets.some(ds => ds.label === 'Bent')) {
                addBentLegendNote = true;
            }
            // --- End Special Handling ---

            if (filteredChartData.datasets.length === 0 && !addBentLegendNote) { // Don't abort if we need to add Bent's note
                console.warn(`No data to display for chart "${canvasId}" after filtering.`);
                return null; // Don't create chart if no data and no note needed
            }

            // --- Scales Configuration ---
            let scalesConfig = {};
            if (axisType === 'time') { const range = calculateTimeAxisRange(filteredChartData.datasets); scalesConfig = { y: { min: range.min, max: range.max, title: { display: true, text: 'Zeit (s)' } }, x: exercises.length === 1 ? { ticks: { display: true } } : {} }; }
            else if (axisType === 'count') { scalesConfig = { y: { beginAtZero: true, title: { display: true, text: 'Anzahl' } }, x: { ticks: { display: true } } }; }
            else if (axisType === 'distance') { scalesConfig = { y: { beginAtZero: true, title: { display: true, text: 'Distanz (m)' } }, x: { ticks: { display: true } } }; }

            // --- Default Options ---
            const defaultOptions = {
                responsive: true,
                plugins: {
                    title: { display: false },
                    legend: {
                        position: 'bottom',
                        labels: {
                             // Default generateLabels will be used unless overridden below
                        }
                    },
                    tooltip: {
                        callbacks: { label: (context) => { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null && typeof context.parsed.y === 'number') { if (axisType === 'time') label += context.parsed.y.toFixed(2) + ' s'; else if (axisType === 'count') label += context.parsed.y + ' mal'; else if (axisType === 'distance') label += context.parsed.y + ' m'; else label += context.parsed.y; } else { label += 'N/A'; } return label; } }
                    },
                    datalabels: typeof ChartDataLabels !== 'undefined' ? defaultDatalabelsConfig : { display: false } // Only add datalabels if plugin loaded
                },
                scales: scalesConfig,
                indexAxis: exercises.length === 1 ? 'x' : 'x'
            };

            // --- Apply Legend Customization if needed ---
            if (addBentLegendNote) {
                defaultOptions.plugins.legend.labels.generateLabels = function(chart) {
                    const defaultLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                    const bentIndex = players.indexOf('Bent');

                    if (bentIndex !== -1) {
                        const colors = [ 'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)' ];
                        const borderColors = [ 'rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)' ];

                        const bentLegendItem = {
                            text: "Bent (2x fehlgeschlagen)",
                            fillStyle: colors[bentIndex % colors.length],
                            strokeStyle: '#ccc', // Use a grey border for the box
                            lineWidth: 1,
                            hidden: false, // Make it visible but styled differently
                            fontColor: '#999', // Grey text color
                            // Optional: Add a class to target with CSS for more styling like line-through
                            // text: `<span class="legend-item-failed">Bent (2x fehlgeschlagen)</span>` // Requires HTML legend, not default
                        };
                         // We can't directly set fontColor easily in v3/v4 standard labels,
                         // 'hidden: true' is the most reliable way to grey it out visually.
                         // Let's try hidden: true for standard grey-out effect.
                         bentLegendItem.hidden = true;


                        defaultLabels.push(bentLegendItem);
                    }
                    return defaultLabels;
                };
            }
            // --- End Legend Customization ---

            // --- Merge Options and Create Chart ---
            const finalOptions = { ...defaultOptions, ...optionsOverrides };
            // Simple merge (won't deep merge plugins/scales if overrides exist, adjust if needed)
            if (optionsOverrides.plugins) finalOptions.plugins = {...defaultOptions.plugins, ...optionsOverrides.plugins};
            if (optionsOverrides.scales) finalOptions.scales = {...defaultOptions.scales, ...optionsOverrides.scales};

            try {
                 console.log(`Creating chart: ${canvasId}`);
                 return new Chart(ctx, { type: type, data: filteredChartData, options: finalOptions }); // Use FILTERED data for drawing
            } catch (error) {
                console.error(`Error creating chart "${canvasId}":`, error);
                return null;
            }
        }

        // Create Charts
        console.log("Attempting to create charts...");
        createChart('sprintChart', ["10m Sprint", "20m Sprint"], 'bar', {}, 'time');
        createChart('agilityChart', ["Gewandtheit"], 'bar', {}, 'time');
        createChart('ballSkillsTimeChart', ["Dribbling", "Ballkontrolle"], 'bar', {}, 'time');
        createChart('jugglingChart', ["Balljonglieren"], 'bar', {}, 'count');
        createChart('yoyoChart', ["YoYo IR1"], 'bar', {}, 'distance');
        console.log("Chart creation calls finished.");

      }); // End DOMContentLoaded
    </script>

  </body>
</html>